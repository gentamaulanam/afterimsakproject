<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Co-op Space AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* Mencegah zoom dan scroll tidak sengaja di HP */
        body { touch-action: none; overscroll-behavior: none; }
        canvas { display: block; margin: 0 auto; background: #0f172a; }
        .btn-active:active { transform: scale(0.95); }
        .glow-text { text-shadow: 0 0 10px rgba(217, 70, 239, 0.8); }
    </style>
</head>
<body class="bg-slate-900 text-white font-sans h-screen w-screen overflow-hidden flex flex-col">

    <!-- SCREEN: MENU UTAMA -->
    <div id="screen-menu" class="flex-1 flex flex-col items-center justify-center p-6 text-center relative overflow-hidden">
        <div class="absolute top-10 left-10 text-yellow-300 opacity-50 text-2xl animate-pulse">‚ú®</div>
        <div class="absolute bottom-20 right-20 text-purple-400 opacity-50 text-4xl animate-pulse" style="animation-delay: 1s;">‚ú®</div>

        <h1 class="text-4xl md:text-6xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-500 glow-text">üöÄ Co-op AI Trivia</h1>
        <p class="mb-12 text-slate-400 max-w-md">Satu layar sebagai Host (PC). Pemain 1 menjawab benar = pesawat geser Kiri. Pemain 2 menjawab benar = pesawat geser Kanan. Hindari batu asteroid!</p>
        
        <div class="flex flex-col gap-4 w-full max-w-xs z-10">
            <button onclick="showHostScreen()" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 px-6 rounded-xl text-xl shadow-[0_0_15px_rgba(79,70,229,0.5)] transition">
                üñ•Ô∏è Buat Game (Host)
            </button>
            <button onclick="showLoginScreen()" class="bg-teal-500 hover:bg-teal-400 text-white font-bold py-4 px-6 rounded-xl text-xl shadow-[0_0_15px_rgba(20,184,166,0.5)] transition">
                üì± Masuk Game (Player)
            </button>
        </div>
    </div>

    <!-- SCREEN: HOST -->
    <div id="screen-host" class="hidden flex-1 flex flex-col h-full w-full">
        <div class="bg-slate-800 p-4 flex justify-between items-center shadow-md z-10 border-b border-purple-500/30">
            <div>
                <span class="text-slate-400 text-sm">Room ID:</span>
                <h2 id="host-room-id" class="text-3xl font-mono font-bold text-yellow-400 tracking-wider">----</h2>
            </div>
            <div class="flex gap-4 text-sm md:text-base">
                <div id="status-p1" class="px-4 py-2 rounded-lg bg-slate-700 text-slate-400 font-semibold border-2 border-transparent transition-colors">P1 (Kiri): Menunggu...</div>
                <div id="status-p2" class="px-4 py-2 rounded-lg bg-slate-700 text-slate-400 font-semibold border-2 border-transparent transition-colors">P2 (Kanan): Menunggu...</div>
            </div>
        </div>
        <div class="flex-1 relative w-full flex justify-center items-center bg-black">
            <canvas id="gameCanvas"></canvas>
            
            <!-- Layar Game Over / Menunggu -->
            <div id="host-overlay" class="absolute inset-0 bg-slate-900/90 flex items-center justify-center flex-col z-20 backdrop-blur-sm">
                <h2 id="overlay-title" class="text-4xl md:text-5xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500">Menunggu Pemain...</h2>
                <p id="overlay-desc" class="text-xl text-slate-300 mb-8">Buka web ini di HP dan masukkan Room ID di atas.</p>
                
                <div class="bg-slate-800/80 p-6 rounded-2xl border border-purple-500/50 flex flex-col items-center max-w-md text-center w-[90%]">
                    <label class="text-purple-300 font-bold mb-2 text-lg">‚ú® Tema Soal AI (Gemini)</label>
                    <p class="text-xs text-slate-400 mb-4">Pemain harus terus menjawab soal untuk bergerak.</p>
                    <input type="text" id="ai-theme-input" placeholder="Misal: Hewan, Sejarah..." class="w-full text-center text-xl bg-slate-900 border-2 border-slate-600 rounded-xl py-3 px-4 focus:outline-none focus:border-purple-400 text-white shadow-inner mb-6 transition-colors" value="Luar Angkasa">
                    
                    <button id="btn-restart" onclick="resetGame()" class="hidden w-full bg-gradient-to-r from-purple-600 to-indigo-600 py-3 rounded-xl font-bold text-xl hover:from-purple-500 hover:to-indigo-500 shadow-[0_0_15px_rgba(168,85,247,0.4)] transition-all">‚ú® Main Lagi</button>
                    <div id="waiting-spinner" class="mt-4 flex gap-2">
                        <div class="w-3 h-3 bg-purple-500 rounded-full animate-bounce"></div>
                        <div class="w-3 h-3 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                        <div class="w-3 h-3 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SCREEN: PLAYER LOGIN -->
    <div id="screen-login" class="hidden flex-1 flex flex-col items-center justify-center p-6 relative">
        <h2 class="text-3xl font-bold mb-8 text-cyan-400">Masuk ke Room</h2>
        <input type="text" id="input-room-id" placeholder="Mskn 4 Digit ID" class="text-center text-4xl font-mono bg-slate-800 border-2 border-slate-600 rounded-xl py-4 px-6 mb-6 w-full max-w-xs focus:outline-none focus:border-cyan-400 uppercase shadow-inner" maxlength="4">
        <button onclick="joinGame()" id="btn-join" class="bg-teal-500 text-white font-bold py-4 px-8 rounded-xl text-xl w-full max-w-xs btn-active shadow-[0_0_15px_rgba(20,184,166,0.5)]">
            Hubungkan
        </button>
        <p id="login-error" class="text-pink-400 mt-4 hidden bg-pink-500/10 px-4 py-2 rounded-lg border border-pink-500/50">‚ö†Ô∏è Gagal terhubung. Cek kembali ID Room.</p>
    </div>

    <!-- SCREEN: CONTROLLER (HP) -->
    <div id="screen-controller" class="hidden flex-1 flex flex-col h-full bg-slate-900 select-none">
        <!-- Status Bar -->
        <div class="p-4 bg-slate-800 text-center shadow-md flex justify-between items-center border-b border-slate-700">
            <span class="font-bold text-slate-400">Room: <span id="ctrl-room-id" class="text-white"></span></span>
            <span id="player-role-badge" class="px-3 py-1 rounded-full text-sm font-bold bg-cyan-600 shadow-[0_0_10px_rgba(8,145,178,0.5)]">Player</span>
        </div>

        <!-- Area Pertanyaan (Sekarang Penuh) -->
        <div id="ctrl-question-area" class="flex-1 p-4 flex flex-col items-center bg-slate-900 justify-center">
            
            <div id="q-feedback" class="text-2xl font-bold mb-2 h-8 text-center transition-opacity opacity-0">Benar!</div>
            
            <div class="bg-slate-800 p-6 rounded-2xl border border-purple-500/30 w-full mb-6 shadow-lg min-h-[120px] flex items-center justify-center">
                <h3 id="q-text" class="text-xl md:text-2xl text-yellow-300 font-bold text-center leading-snug">
                    Menunggu Game Dimulai...
                </h3>
            </div>

            <div class="grid grid-cols-2 gap-4 w-full h-64">
                <button id="ans-btn-0" class="bg-slate-700 text-white text-lg md:text-xl font-bold rounded-2xl btn-active opacity-50 cursor-not-allowed transition-all p-2 break-words shadow-inner" disabled onclick="sendAnswer(0)">-</button>
                <button id="ans-btn-1" class="bg-slate-700 text-white text-lg md:text-xl font-bold rounded-2xl btn-active opacity-50 cursor-not-allowed transition-all p-2 break-words shadow-inner" disabled onclick="sendAnswer(1)">-</button>
                <button id="ans-btn-2" class="bg-slate-700 text-white text-lg md:text-xl font-bold rounded-2xl btn-active opacity-50 cursor-not-allowed transition-all p-2 break-words shadow-inner" disabled onclick="sendAnswer(2)">-</button>
                <button id="ans-btn-3" class="bg-slate-700 text-white text-lg md:text-xl font-bold rounded-2xl btn-active opacity-50 cursor-not-allowed transition-all p-2 break-words shadow-inner" disabled onclick="sendAnswer(3)">-</button>
            </div>
            
            <div class="mt-8 text-slate-500 font-semibold text-sm text-center">
                Jawab benar untuk menggeser pesawat!
            </div>
        </div>
    </div>

    <script>
        // --- KONFIGURASI API GEMINI ---
        const apiKey = ""; // Disediakan oleh runtime
        let isFetchingAI = false;
        let aiTheme = "Luar Angkasa";
        let aiQuestionPool = []; // Menyimpan kumpulan soal agar tidak lag

        // --- VARIABEL GLOBAL ---
        let peer = null;
        let connections = { p1: null, p2: null };
        let hostId = null;
        let myRole = null; 
        let myConnection = null; 

        // Variabel Game
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas?.getContext('2d');
        let gameLoop;
        let isPlaying = false;
        
        // Ship sekarang menggunakan targetX untuk gerak mulus
        let ship = { x: 200, targetX: 200, y: 500, width: 44, height: 44, color: '#06b6d4', moveStep: 50 };
        let obstacles = [];
        let stars = []; 
        let score = 0;
        let hp = 3;
        let frameCount = 0;

        for(let i=0; i<50; i++) {
            stars.push({ x: Math.random() * 800, y: Math.random() * 800, size: Math.random() * 2 + 1, speed: Math.random() * 2 + 0.5 });
        }

        // --- INTEGRASI GEMINI API ‚ú® ---
        // Fetch 10 soal sekaligus agar saat pemain menjawab, soal baru langsung tersedia
        async function fetchAIBatch(theme) {
            if (!apiKey || isFetchingAI) return;
            isFetchingAI = true;

            const promptText = `Buat 10 pertanyaan trivia singkat bertema "${theme}". Pertanyaan maksimal 6 kata. Berikan 1 jawaban benar dan 3 jawaban salah (maksimal 2 kata per jawaban). Kembalikan dalam format JSON array.`;
            
            const payload = {
                contents: [{ parts: [{ text: promptText }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                q: { type: "STRING" },
                                ans: { type: "STRING" },
                                w1: { type: "STRING" },
                                w2: { type: "STRING" },
                                w3: { type: "STRING" }
                            },
                            required: ["q", "ans", "w1", "w2", "w3"]
                        }
                    }
                }
            };

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.candidates && result.candidates[0].content.parts[0].text) {
                        const newQuestions = JSON.parse(result.candidates[0].content.parts[0].text);
                        aiQuestionPool.push(...newQuestions);
                    }
                }
            } catch (e) {
                console.warn(`Gagal memuat batch AI. Fallback ke Matematika.`);
            }
            isFetchingAI = false;
        }

        function generateMathQuestion() {
            const isPlus = Math.random() > 0.5;
            const n1 = Math.floor(Math.random() * 15) + 1;
            const n2 = Math.floor(Math.random() * 15) + 1;
            const ans = isPlus ? n1 + n2 : n1 * n2;
            const op = isPlus ? '+' : 'x';
            return {
                q: `${n1} ${op} ${n2} = ?`,
                ans: ans.toString(),
                w1: (ans + 1).toString(),
                w2: (ans - 2).toString(),
                w3: (ans + 5).toString()
            };
        }

        function getNextQuestionData() {
            if (aiQuestionPool.length > 0) {
                // Trigger fetch lagi kalau soal AI mau habis
                if (aiQuestionPool.length < 4 && !isFetchingAI) fetchAIBatch(aiTheme);
                let qData = aiQuestionPool.pop();
                qData.q = "‚ú® " + qData.q; // Tanda ini dari AI
                return qData;
            } else {
                // Coba fetch jika pool kosong
                if (apiKey && !isFetchingAI) fetchAIBatch(aiTheme);
                return generateMathQuestion();
            }
        }

        // --- SISTEM PEERJS (WEB RTC) ---
        function generateRoomId() { return Math.floor(1000 + Math.random() * 9000).toString(); }

        function showHostScreen() {
            document.getElementById('screen-menu').classList.add('hidden');
            document.getElementById('screen-host').classList.remove('hidden');
            myRole = 'host';
            hostId = generateRoomId();
            document.getElementById('host-room-id').innerText = hostId;

            peer = new Peer(`ai-trivia-${hostId}`);

            peer.on('open', (id) => resizeCanvas());

            peer.on('connection', (conn) => {
                conn.on('open', () => {
                    let assignedRole = '';
                    if (!connections.p1) { assignedRole = 'p1'; connections.p1 = conn; } 
                    else if (!connections.p2) { assignedRole = 'p2'; connections.p2 = conn; } 
                    else { conn.send({ type: 'error', msg: 'Room Penuh!' }); conn.close(); return; }

                    updateHostUI(assignedRole, true);
                    conn.send({ type: 'init', role: assignedRole });

                    if (connections.p1 && connections.p2 && !isPlaying) {
                        document.getElementById('waiting-spinner').classList.add('hidden');
                        document.getElementById('btn-restart').classList.remove('hidden');
                        document.getElementById('overlay-title').innerText = "Semua Pemain Siap!";
                        document.getElementById('btn-restart').innerText = "‚ú® Mulai Game";
                    }

                    conn.on('data', (data) => handleControllerInput(assignedRole, data));

                    conn.on('close', () => {
                        if (connections.p1 === conn) { connections.p1 = null; updateHostUI('p1', false); }
                        if (connections.p2 === conn) { connections.p2 = null; updateHostUI('p2', false); }
                        pauseGame('Pemain terputus, menunggu...');
                    });
                });
            });
        }

        function updateHostUI(player, isConnected) {
            const el = document.getElementById(`status-${player}`);
            if (isConnected) {
                el.classList.replace('bg-slate-700', 'bg-green-600');
                el.classList.replace('text-slate-400', 'text-white');
                el.innerText = player === 'p1' ? 'P1 (Kiri) ‚úì' : 'P2 (Kanan) ‚úì';
            } else {
                el.classList.replace('bg-green-600', 'bg-slate-700');
                el.classList.replace('text-white', 'text-slate-400');
                el.innerText = player === 'p1' ? 'P1 (Kiri): Menunggu' : 'P2 (Kanan): Menunggu';
            }
        }

        function showLoginScreen() {
            document.getElementById('screen-menu').classList.add('hidden');
            document.getElementById('screen-login').classList.remove('hidden');
        }

        function joinGame() {
            const roomId = document.getElementById('input-room-id').value.trim();
            if (roomId.length !== 4) return;

            const btn = document.getElementById('btn-join');
            btn.innerText = "Menghubungkan...";
            btn.classList.add('animate-pulse');
            document.getElementById('login-error').classList.add('hidden');

            peer = new Peer();
            peer.on('open', (id) => {
                myConnection = peer.connect(`ai-trivia-${roomId}`);
                myConnection.on('open', () => {
                    document.getElementById('screen-login').classList.add('hidden');
                    document.getElementById('screen-controller').classList.remove('hidden');
                    document.getElementById('ctrl-room-id').innerText = roomId;
                });

                myConnection.on('data', (data) => {
                    if (data.type === 'init') {
                        myRole = data.role; 
                        setupControllerUI(myRole);
                    } else if (data.type === 'question') {
                        showQuestionUI(data.qStr, data.options, data.answer);
                    } else if (data.type === 'error') {
                        alert(data.msg);
                        location.reload();
                    } else if (data.type === 'stop') {
                        document.getElementById('q-text').innerText = "Game Berakhir / Dijeda";
                        [0,1,2,3].forEach(i => {
                            const btn = document.getElementById(`ans-btn-${i}`);
                            btn.innerText = "-";
                            btn.disabled = true;
                            btn.className = 'bg-slate-800 text-slate-500 text-xl font-bold rounded-2xl opacity-50 cursor-not-allowed p-2 shadow-inner border border-slate-700';
                        });
                    }
                });
                myConnection.on('error', () => showLoginError());
            });
            peer.on('error', () => showLoginError());
        }

        function showLoginError() {
            const btn = document.getElementById('btn-join');
            btn.innerText = "Hubungkan";
            btn.classList.remove('animate-pulse');
            document.getElementById('login-error').classList.remove('hidden');
        }

        // --- CONTROLLER UI & LOGIC ---
        function setupControllerUI(role) {
            const badge = document.getElementById('player-role-badge');
            if (role === 'p1') {
                badge.innerText = 'P1 (Bergerak ke Kiri)';
                badge.className = 'px-3 py-1 rounded-full text-sm font-bold bg-indigo-500 text-white';
            } else {
                badge.innerText = 'P2 (Bergerak ke Kanan)';
                badge.className = 'px-3 py-1 rounded-full text-sm font-bold bg-teal-500 text-white';
            }
        }

        let currentAnswer = null;
        function showQuestionUI(qStr, options, answer) {
            currentAnswer = answer;
            document.getElementById('q-text').innerText = qStr;
            
            for(let i=0; i<4; i++) {
                const btn = document.getElementById(`ans-btn-${i}`);
                btn.innerText = options[i];
                btn.disabled = false;
                
                // Tema warna berdasarkan role
                if(myRole === 'p1') {
                    btn.className = 'bg-gradient-to-b from-indigo-500 to-indigo-700 text-white text-lg md:text-xl font-bold rounded-2xl btn-active shadow-[0_4px_0_rgba(49,46,129,1)] active:shadow-[0_0px_0_rgba(49,46,129,1)] active:translate-y-1 transition-all p-2 break-words border border-indigo-400/50';
                } else {
                    btn.className = 'bg-gradient-to-b from-teal-500 to-teal-700 text-white text-lg md:text-xl font-bold rounded-2xl btn-active shadow-[0_4px_0_rgba(17,94,89,1)] active:shadow-[0_0px_0_rgba(17,94,89,1)] active:translate-y-1 transition-all p-2 break-words border border-teal-400/50';
                }
            }
        }

        function sendAnswer(index) {
            if (!myConnection) return;
            const btn = document.getElementById(`ans-btn-${index}`);
            const chosen = btn.innerText;
            const isCorrect = (chosen === currentAnswer);

            const feedback = document.getElementById('q-feedback');
            if(isCorrect) {
                feedback.innerText = "Benar! üöÄ";
                feedback.className = "text-2xl font-bold mb-2 h-8 text-center text-green-400 transition-opacity opacity-100";
            } else {
                feedback.innerText = "Salah! ‚ùå";
                feedback.className = "text-2xl font-bold mb-2 h-8 text-center text-red-400 transition-opacity opacity-100";
            }
            setTimeout(() => feedback.classList.replace('opacity-100', 'opacity-0'), 1000);

            // Matikan tombol sementara tunggu soal berikutnya
            [0,1,2,3].forEach(i => document.getElementById(`ans-btn-${i}`).disabled = true);
            
            myConnection.send({ type: 'answer_result', isCorrect: isCorrect });
        }


        // --- GAME ENGINE (HOST LOGIC) ---
        function handleControllerInput(role, data) {
            if (!isPlaying) return;

            if (data.type === 'answer_result') {
                if (data.isCorrect) {
                    score += 15;
                    // Gerakkan pesawat (P1 = Kiri, P2 = Kanan)
                    if (role === 'p1') ship.targetX -= ship.moveStep;
                    if (role === 'p2') ship.targetX += ship.moveStep;
                    
                    // Batasi gerak agar tidak keluar layar
                    ship.targetX = Math.max(0, Math.min(canvas.width - ship.width, ship.targetX));

                    // Efek visual Host
                    canvas.style.backgroundColor = role === 'p1' ? 'rgba(79, 70, 229, 0.2)' : 'rgba(20, 184, 166, 0.2)';
                    setTimeout(() => canvas.style.backgroundColor = 'transparent', 150);
                } else {
                    // Salah tidak gerak, layar kedip merah sebentar
                    canvas.style.backgroundColor = 'rgba(225, 29, 72, 0.2)';
                    setTimeout(() => canvas.style.backgroundColor = 'transparent', 150);
                }
                
                // Langsung kirim soal baru ke pemain tersebut
                sendNewQuestionToPlayer(role);
            }
        }

        function sendNewQuestionToPlayer(role) {
            const conn = role === 'p1' ? connections.p1 : connections.p2;
            if(!conn) return;

            const qData = getNextQuestionData();
            let options = [qData.ans, qData.w1, qData.w2, qData.w3];
            // Acak urutan opsi
            for (let i = options.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [options[i], options[j]] = [options[j], options[i]];
            }
            conn.send({ type: 'question', qStr: qData.q, options: options, answer: qData.ans });
        }

        function resizeCanvas() {
            const container = canvas.parentElement;
            let w = container.clientWidth;
            let h = container.clientHeight;
            if (w > 600) w = 600; 

            canvas.width = w;
            canvas.height = h;
            ship.y = canvas.height - 120;
            if(!isPlaying) {
                ship.x = canvas.width / 2 - ship.width / 2;
                ship.targetX = ship.x;
            }
            stars.forEach(s => s.x = Math.random() * canvas.width);
        }

        window.addEventListener('resize', () => { if (myRole === 'host') resizeCanvas(); });

        function startGame() {
            const themeInput = document.getElementById('ai-theme-input').value.trim();
            aiTheme = themeInput !== "" ? themeInput : "Astronomi";

            document.getElementById('host-overlay').classList.add('hidden');
            isPlaying = true;
            score = 0;
            hp = 3;
            obstacles = [];
            frameCount = 0;
            aiQuestionPool = [];
            
            resizeCanvas();
            ship.x = canvas.width / 2 - ship.width / 2;
            ship.targetX = ship.x;

            // Fetch AI pertama kali (jalan di background)
            fetchAIBatch(aiTheme);

            // Kirim soal pertama ke kedua pemain
            sendNewQuestionToPlayer('p1');
            sendNewQuestionToPlayer('p2');

            if(!gameLoop) loop();
        }

        function pauseGame(msg) {
            isPlaying = false;
            document.getElementById('host-overlay').classList.remove('hidden');
            document.getElementById('overlay-title').innerText = "Dijeda";
            document.getElementById('overlay-desc').innerText = msg;
            
            document.getElementById('ai-theme-input').classList.add('hidden');
            document.getElementById('btn-restart').classList.add('hidden');
            document.getElementById('waiting-spinner').classList.remove('hidden');

            if(connections.p1) connections.p1.send({type: 'stop'});
            if(connections.p2) connections.p2.send({type: 'stop'});
        }

        function gameOver() {
            isPlaying = false;
            document.getElementById('host-overlay').classList.remove('hidden');
            document.getElementById('overlay-title').innerText = "Game Over!";
            document.getElementById('overlay-desc').innerText = `Skor Akhir: ${score}`;
            
            document.getElementById('ai-theme-input').classList.remove('hidden');
            document.getElementById('waiting-spinner').classList.add('hidden');
            document.getElementById('btn-restart').classList.remove('hidden');
            document.getElementById('btn-restart').innerText = "‚ú® Main Lagi";

            if(connections.p1) connections.p1.send({type: 'stop'});
            if(connections.p2) connections.p2.send({type: 'stop'});
        }

        function resetGame() {
            if (connections.p1 && connections.p2) startGame();
            else pauseGame('Menunggu pemain lengkap...');
        }

        function updateGame() {
            stars.forEach(s => {
                s.y += s.speed;
                if(s.y > canvas.height) { s.y = 0; s.x = Math.random() * canvas.width; }
            });

            // Interpolasi gerak mulus ke targetX
            ship.x += (ship.targetX - ship.x) * 0.15;

            // Tambah skor perlahan saat bertahan hidup
            if(frameCount % 60 === 0) score += 5;

            // Spawn Obstacle Biasa (Batu Asteroid)
            // Spawn semakin cepat seiring waktu (berdasarkan score)
            let spawnRate = Math.max(20, 70 - Math.floor(score / 100));
            if (frameCount % spawnRate === 0 && Math.random() > 0.2) {
                obstacles.push({
                    x: Math.random() * (canvas.width - 40),
                    y: -40,
                    width: 35 + Math.random() * 20,
                    height: 35 + Math.random() * 20,
                    speed: 3 + (score / 300)
                });
            }

            for (let i = obstacles.length - 1; i >= 0; i--) {
                let obs = obstacles[i];
                obs.y += obs.speed;

                // Hitbox simpel
                if (ship.x < obs.x + obs.width - 5 &&
                    ship.x + ship.width > obs.x + 5 &&
                    ship.y < obs.y + obs.height - 5 &&
                    ship.y + ship.height > obs.y + 5) {
                    
                    hp--;
                    obstacles.splice(i, 1);
                    canvas.style.backgroundColor = 'rgba(225, 29, 72, 0.4)';
                    setTimeout(() => canvas.style.backgroundColor = 'transparent', 150);
                    if (hp <= 0) gameOver();
                } else if (obs.y > canvas.height) {
                    obstacles.splice(i, 1);
                }
            }

            frameCount++;
        }

        function drawGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Bintang
            ctx.fillStyle = '#ffffff';
            stars.forEach(s => {
                ctx.globalAlpha = s.size / 3;
                ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2); ctx.fill();
            });
            ctx.globalAlpha = 1.0;

            // Pesawat
            ctx.save();
            ctx.translate(ship.x + ship.width/2, ship.y + ship.height/2);
            
            ctx.fillStyle = (frameCount % 4 < 2) ? '#f59e0b' : '#ef4444'; 
            ctx.beginPath(); ctx.moveTo(-10, ship.height/2); ctx.lineTo(10, ship.height/2); ctx.lineTo(0, ship.height/2 + 20 + Math.random()*10); ctx.fill();

            ctx.fillStyle = '#1e1b4b'; 
            ctx.beginPath(); ctx.moveTo(0, -ship.height/2); ctx.lineTo(ship.width/2 + 10, ship.height/2); ctx.lineTo(-ship.width/2 - 10, ship.height/2); ctx.fill();

            ctx.fillStyle = ship.color; 
            ctx.beginPath(); ctx.moveTo(0, -ship.height/2 - 5); ctx.lineTo(ship.width/2 - 5, ship.height/2); ctx.lineTo(-ship.width/2 + 5, ship.height/2); ctx.fill();
            
            ctx.restore();

            // Asteroid
            ctx.fillStyle = '#94a3b8'; 
            obstacles.forEach(obs => {
                ctx.beginPath(); ctx.roundRect(obs.x, obs.y, obs.width, obs.height, 8); ctx.fill();
                ctx.fillStyle = '#64748b';
                ctx.beginPath(); ctx.arc(obs.x + 10, obs.y + 10, 4, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#94a3b8'; 
            });

            // UI HUD
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 20px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText(`HP: ${'‚ù§Ô∏è'.repeat(hp)}`, 15, 35);
            ctx.textAlign = 'right';
            ctx.fillText(`Skor: ${score}`, canvas.width - 15, 35);
        }

        function loop() {
            if (isPlaying) { updateGame(); drawGame(); }
            gameLoop = requestAnimationFrame(loop);
        }

    </script>
</body>
</html>
